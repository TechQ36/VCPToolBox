# VCPToolBox 项目初始化指南

> 本文档根据代码整理，供本地查阅。按此步骤即可完成项目初始化并启动服务。  
> **快速打开文件**：在 Cursor/VS Code 中 **Ctrl+点击**（Mac 用 Cmd+点击）文档中的文件名链接，即可跳转到对应文件。

---

## 一、代码里的“入口”与依赖顺序

[`server.js`](../server.js) 启动时：

1. **最先加载 [`config.env`](../config.env)**（第 3-4 行）  
   - `dotenv.config({ path: 'config.env' });`  
   - 之后所有 `process.env.XXX` 都来自该文件；**没有该文件时，这些变量为 `undefined`**。

2. **随后按顺序 require 各模块**（第 14-91 行）  
   - 其中 [`KnowledgeBaseManager.js`](../KnowledgeBaseManager.js) 在加载时会 `require('./rust-vexus-lite')`，失败会 **`process.exit(1)`**（[KnowledgeBaseManager.js](../KnowledgeBaseManager.js) 第 16-24 行）。  
   - 因此 **Rust Vexus-Lite 必须存在且能加载**，否则进程直接退出。

真正“初始化”在 **`app.listen(port, async () => { ... })`** 的回调里（约 1178-1225 行），顺序为：

- 加载 IP 黑名单  
- 确保 Agent 目录存在  
- 加载模型重定向配置 [`ModelRedirect.json`](../ModelRedirect.json.example)  
- 初始化 Agent 管理器（`AGENT_DIR`）  
- 初始化 TVS 管理器（`TVStxt`）  
- 调用 **`initialize()`**（约 1076-1174 行），内部依次：  
  - 初始化知识库（向量数据库）  
  - 设置项目根路径、注入 VectorDBManager  
  - 加载插件  
  - 注入 WebSocketServer、初始化服务类插件、挂载 `/admin_api` 与论坛 API  
  - 依赖注入到预处理器与服务  
  - 初始化静态插件、预热 Python 插件  
  - 加载表情包列表缓存  
  - 初始化任务调度器  
- 再初始化 WebSocketServer、FileFetcherServer 等

下面按“你要做什么”列出具体步骤。

---

## 二、初始化步骤（按代码要求）

### 1. 环境与依赖

- **Node.js**：需能运行当前项目（建议 LTS）。
- **npm**：在项目根目录执行一次：
  ```bash
  npm install
  ```
  会安装 [`package.json`](../package.json) 里所有依赖（如 `better-sqlite3`、`chokidar`、`express`、`ws` 等）。

- **Rust Vexus-Lite**：  
  - 代码写死要 `require('./rust-vexus-lite')`，失败就退出。  
  - 仓库内已有预编译的 `.node`（如 [rust-vexus-lite](../rust-vexus-lite/) 下的 `vexus-lite.win32-x64-msvc.node`），一般**无需自行编译**，只要不删 [rust-vexus-lite](../rust-vexus-lite/) 目录且平台对应即可。

- **Python**（可选）：  
  - 若启用带 Python 的插件（如 SciCalculator），需本机有 `python` 且能 `import sympy, scipy, numpy` 等。  
  - 根目录有 [`requirements.txt`](../requirements.txt)，可执行：
    ```bash
    pip install -r requirements.txt
    ```
  - 不启用这些插件可暂不装；仅会少部分功能或 prewarm 时打 stderr 警告。

### 2. 配置文件（必做）

- 在**项目根目录**复制一份配置模板：
  - [config.env.example](../config.env.example) → [config.env](../config.env)
- **至少**修改以下项（否则聊天/鉴权会异常或无法使用）：
  - **`API_Key`**、**`API_URL`**：后端 AI 的密钥与地址（如 NewAPI/OpenAI 兼容接口）。
  - **`PORT`**：本机监听端口（如 `6005`）。
  - **`Key`**：调用 `/v1/chat/completions` 等接口时的 Bearer 密钥。
- 代码中直接使用（[server.js](../server.js) 309-312 行）：
  - `port = process.env.PORT`
  - `apiKey = process.env.API_Key`
  - `apiUrl = process.env.API_URL`
  - `serverKey = process.env.Key`  
  若为空，请求转发或鉴权会出问题。

- **建议同时配置**：  
  - **`AdminUsername` / `AdminPassword`**：管理面板登录；不设则管理面板会 503。  
  - **`CALLBACK_BASE_URL`**：异步插件回调地址，如 `http://localhost:6005/plugin-callback`（需与 `PORT` 一致）。  
  - 若使用 RAG/知识库：  
    - **`KNOWLEDGEBASE_ROOT_PATH`**（默认 `./dailynote`）、**`KNOWLEDGEBASE_STORE_PATH`**（默认 `./VectorStore`）  
    - **`VECTORDB_DIMENSION`** 必须与嵌入模型一致（如 3072 / 1536）。  
  - **`DEFAULT_TIMEZONE`**：如 `Asia/Shanghai`，用于日志与调度。

### 3. 目录与可选文件

代码中**会自动创建**或依赖的目录/文件：

- **Agent 目录**（[server.js](../server.js) 44-66 行）：  
  - 由 `AGENT_DIR` 决定，默认 `path.join(__dirname, 'Agent')`，也可通过 [config.env](../config.env) 中 `AGENT_DIR_PATH` 覆盖。  
  - 启动时 `ensureAgentDirectory()` 会执行 `fs.mkdir(AGENT_DIR, { recursive: true })`，**不存在会自动创建**。

- **知识库/向量库**（[KnowledgeBaseManager.js](../KnowledgeBaseManager.js) 74-78 行）：  
  - `storePath`（默认 `VectorStore`）在 `initialize()` 里会 `fs.mkdir(this.config.storePath, { recursive: true })`，**会自动创建**。  
  - 库文件 `knowledge_base.sqlite` 与索引会在该目录下创建或加载。

- **日志**（[modules/logger.js](../modules/logger.js)）：  
  - 使用 `DebugLog`、`archive` 等目录，一般会在首次写日志时创建。

- **插件目录**（[Plugin.js](../Plugin.js) 12、429 行）：  
  - 固定为项目下的 **`Plugin`**，只扫描该目录下的子目录；每个插件目录内需有 **`plugin-manifest.json`** 才会被加载。  
  - 无需你“初始化”该目录，只要不删即可。

- **TVStxt**（[server.js](../server.js) 66 行）：  
  - 路径为 `path.join(__dirname, 'TVStxt')`，用于高级变量/占位符；若不存在，相关功能可能读不到文件，但一般不会阻止启动。

- **[ModelRedirect.json](../ModelRedirect.json.example)**（[server.js](../server.js) 1192 行）：  
  - `modelRedirectHandler.loadModelRedirectConfig(path.join(__dirname, 'ModelRedirect.json'))`；  
  - 若文件不存在，可能是“找不到文件”的日志或回退为空配置，需看 `modelRedirectHandler` 的实现；通常不会导致进程退出。

- **[ip_blacklist.json](../ip_blacklist.json)**（[server.js](../server.js) 79、178-179 行）：  
  - 若不存在，`loadBlacklist()` 里会 catch `ENOENT` 并调用 `saveBlacklist()` 写入空数组，**相当于自动创建**。

因此：**你主要需要准备好 [config.env](../config.env)**；Agent、VectorStore、DebugLog、Plugin 等按代码要么自动创建，要么已存在即可。

### 4. 启动命令

- 在项目根目录执行：
  ```bash
  node server.js
  ```
- 成功时控制台会依次出现类似输出（与上述初始化顺序一致）：
  - 向量数据库初始化完成  
  - 插件加载完成  
  - 服务类插件初始化完成  
  - 静态插件初始化完成  
  - 表情包列表缓存加载  
  - 中间层服务器正在监听端口 `<PORT>`  
  - API 服务器地址 `<API_URL>`  
  - 模型重定向配置加载完成  
  - Agent / TVS 管理器初始化完成  
  - WebSocketServer、FileFetcherServer 等

- 若 **`config.env` 不存在**：  
  - 不会立刻报错，但 `PORT`、`Key`、`API_Key`、`API_URL` 等为 `undefined`，  
  - 可能出现 `app.listen(undefined)` 行为异常或请求鉴权/转发失败。

- 若 **Rust Vexus-Lite 加载失败**：  
  - 在 require [KnowledgeBaseManager.js](../KnowledgeBaseManager.js) 时就会 `process.exit(1)`，  
  - 控制台会看到：`[KnowledgeBase] ❌ Critical: Vexus-Lite not found.`

---

## 三、小结（按代码的“初始化”含义）

| 步骤 | 做什么 | 代码依据 |
|------|--------|----------|
| 1 | 安装 Node 依赖：`npm install` | 无 config 时仍可启动，但运行会缺依赖 |
| 2 | 复制 [config.env.example](../config.env.example) 为 [config.env](../config.env)，并至少填写 `API_Key`、`API_URL`、`PORT`、`Key` | `dotenv.config({ path: 'config.env' })`；[server.js](../server.js) 309-312 行使用这些变量 |
| 3 | 确保 [rust-vexus-lite](../rust-vexus-lite/) 存在且当前平台有对应 `.node` | [KnowledgeBaseManager.js](../KnowledgeBaseManager.js) 中 require 失败会 `process.exit(1)` |
| 4 | （可选）安装 Python、`pip install -r requirements.txt`，若使用相关插件 | 插件 prewarm / 执行时会用到 |
| 5 | 运行 `node server.js` | 入口 [server.js](../server.js)；`app.listen` 回调内完成 Agent/TVS/知识库/插件/WebSocket 等初始化 |

**“初始化这个项目”在代码里就等于**：装好依赖、配好 `config.env`、保证 Vexus-Lite 能加载，然后执行一次 `node server.js`；其余目录和文件会按上述顺序在启动过程中自动创建或使用默认值。

---

## 四、config.env 必填/建议项速查

| 变量 | 必填 | 说明 |
|------|------|------|
| API_Key | 是 | 后端 AI API 密钥 |
| API_URL | 是 | 后端 AI API 根地址 |
| PORT | 是 | VCP 服务监听端口 |
| Key | 是 | 调用聊天等接口的 Bearer 密钥 |
| VCP_Key | 建议 | WebSocket / 分布式鉴权 |
| AdminUsername / AdminPassword | 建议 | 管理面板登录 |
| CALLBACK_BASE_URL | 建议 | 异步插件回调，如 `http://localhost:6005/plugin-callback` |
| DEFAULT_TIMEZONE | 建议 | 如 Asia/Shanghai |
| KNOWLEDGEBASE_* / VECTORDB_DIMENSION | 用 RAG 时 | 知识库路径与向量维度，需与嵌入模型一致 |

---

*文档根据当前代码整理，随项目更新可酌情修订。*
